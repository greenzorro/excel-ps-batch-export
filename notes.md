# Excel-PS 批量导出工具备忘录

## 1. 目的

本文档旨在详细记录本项目批量导出工具的全部细节，为本项目的未来开发提供便利。

**重要提示：** 每次新增或修改功能后，请务必更新此备忘录，确保文档的准确性和时效性。

## 2. 项目概述

本项目是一套Python自动化工具，用于将Excel表格数据批量填充到Photoshop(PSD)模板中并导出为图片。它是对Photoshop内置"变量"功能的高效替代，特别适合需要根据大量数据生成统一版式图片的场景。

**核心优势：** 将传统繁琐的Photoshop变量操作流程简化为"编辑Excel→运行脚本"的两步操作。

## 3. 项目结构

```
excel-ps-batch-export/
├── xlsx_generator.py        # Excel生成器 - PSD模板扫描和Excel配置文件生成
├── psd_renderer.py         # 核心PSD渲染脚本
├── file_monitor.py         # 文件监控脚本
├── clipboard_importer.py   # 剪贴板导入器 - 从剪贴板读取数据写入Excel
├── requirements.txt        # 项目依赖管理
├── assets/                 # 资源目录
│   ├── fonts/             # 字体文件
│   └── 1_img/             # 示例图片素材
├── export/                # 导出图片目录
├── log.csv                # 导出日志
├── tests/                 # 测试套件目录
│   ├── README.md          # 测试套件文档
│   ├── run_tests.py       # 统一测试运行器
│   └── *.py              # 测试文件
├── notes.md               # 本备忘录
└── (其他项目文件)
```

## 4. 核心功能

### 4.1 自动化工作流程
- **PSD模板扫描**：自动识别目录中的PSD文件并按前缀分组
- **Excel配置生成**：为每组PSD模板生成共享的Excel配置文件
- **剪贴板数据导入**：从系统剪贴板读取表格数据并写入Excel文件
- **批量图片导出**：读取Excel数据，自动填充到PSD模板并导出
- **实时监控**：监控Excel文件修改，自动触发重新导出

### 4.2 支持的变量类型
- **文本变量** (`@变量名#t`)：替换文本内容，支持多种对齐方式
- **图片变量** (`@变量名#i`)：替换图片内容，自动缩放适配
- **可见性变量** (`@变量名#v`)：控制图层显示/隐藏

### 4.3 旋转文字支持

**命名参数**：
- `@变量名#t_a[角度]` - 旋转指定角度
- 例如：`@标题#t_a15` 旋转 15 度

**使用方式**：
1. 在 PSD 中创建文字图层（不要旋转）
2. 在图层名中添加旋转参数
3. 系统会自动旋转文字并保持位置正确

**示例**：
- `@标题#t` - 无旋转
- `@标题#t_a15` - 旋转 15 度（顺时针）
- `@标题#t_a-30` - 旋转 -30 度（逆时针）
- `@标题#t_c_a45` - 居中 + 旋转 45 度
- `@内容#t_a15_p` - 旋转 15 度 + 段落文本

**组合参数**：
- 旋转参数可与对齐参数组合使用（如 `_c`、`_r`、`_p`）
- `_a` 用于旋转，`_r` 用于右对齐，不会冲突

**技术实现**：
- 创建图层尺寸的临时画布 → 绘制文字 → 旋转 → 中心对齐合成
- 使用 BICUBIC 重采样确保旋转质量
- 自动扩展画布确保旋转后文字不被裁剪

### 4.4 剪贴板导入器
- **智能数据解析**：自动识别制表符和逗号分隔的表格数据，保留第一行数据
- **Excel文件选择**：支持多Excel文件环境下的交互式选择，支持退出功能
- **目标Sheet定位**：优先使用"粘贴"sheet，否则使用第二个sheet
- **安全数据写入**：从B2单元格开始写入，清空右下方区域
- **公式重新计算**：使用xlwings强制Excel重新计算公式，确保数据正确联动
- **自动PSD渲染**：数据导入完成后自动调用PSD渲染器生成图片，实现"数据导入→图片生成"一体化流程
- **跨平台兼容**：正确处理Windows和macOS的编码和路径问题

### 4.5 高级特性
- **多模板支持**：一个Excel文件可对应多个PSD模板
- **智能文件名生成**：正确处理井号分隔符，支持多PSD模板场景
- **文件名合法性清理**：自动清理Excel数据中的非法字符，确保跨平台兼容性
- **统一文本预处理**：在文字写入图片前统一清理空白字符，转换数据类型，规范化特殊字符
- **数据验证**：自动检查Excel数据与PSD模板的匹配性
- **串行处理**：使用简单可靠的单进程串行执行，适合10-50张图片的批量导出
- **进度显示**：使用tqdm实时显示导出进度，每张图片完成后更新
- **错误处理**：单张图片错误不影响其他图片，提供详细的错误报告和修复建议
- **精确文本渲染**：使用Pillow字体度量实现像素级精度的文本位置计算
- **智能布尔值解析**：正确处理Excel中各种形式的布尔值（"TRUE"/"FALSE"/"1"/"0"等）
- **健壮的异常处理**：分层级的错误处理机制，提供智能解决方案建议
- **Excel公式重新计算**：使用xlwings强制Excel重新计算公式，确保数据正确显示
- **稳定的文件生成**：无并发冲突，确保所有图片都能正确生成
- **跨平台文件名兼容性**：自动处理特殊字符，控制长度，确保在所有操作系统上都能正常保存

## 5. 技术架构

### 5.1 核心依赖
- **psd-tools==1.9.23**：PSD文件解析和处理
- **pandas**：Excel数据读取和处理
- **Pillow**：图像合成和文本绘制
- **tqdm==4.66.4**：进度条显示
- **xlwings==0.33.16**：Excel公式重新计算和自动化操作
- **pyperclip==1.11.0**：跨平台剪贴板访问
- **openpyxl**：Excel文件读写操作

### 5.2 关键技术实现
- **PSD预加载**：一次性加载所有PSD模板，避免重复IO操作
- **单进程串行处理**：使用简单for循环逐个处理，代码简单可靠
- **文本渲染**：通过Pillow实现高质量的文本绘制，支持中英文混合
- **图像合成**：使用`alpha_composite`实现精确的图层合成
- **Excel自动化**：使用xlwings实现Excel公式强制重新计算，确保数据正确显示
- **剪贴板数据解析**：智能识别制表符和逗号分隔格式，自动转换为DataFrame
- **安全文件操作**：使用openpyxl进行Excel文件读写，避免数据损坏
- **跨平台编码处理**：安全处理Windows和macOS的编码差异，确保中文显示正常

### 5.3 性能优化
- **简化架构**：单进程避免进程间通信开销和并发冲突，适合10-50张图片的批量导出
- **内存优化**：无并发问题，无需深拷贝操作
- **IO优化**：预加载PSD模板减少磁盘读取次数

## 6. 使用方法

### 6.1 首次设置
1. **准备PSD模板**：将PSD文件放入项目根目录，命名格式为`[前缀]#[后缀].psd`
2. **命名变量图层**：按照`@变量名#操作符`规则重命名需要动态修改的图层
3. **生成Excel配置**：运行`python xlsx_generator.py`生成Excel配置文件
4. **准备资源**：将字体文件放入`assets/fonts`目录

### 6.2 批量导出
```bash
# 手动导出
python psd_renderer.py [模板名] [字体文件] [格式]
# 示例：python psd_renderer.py 1 AlibabaPuHuiTi-2-85-Bold.ttf jpg

# 自动监控导出
python file_monitor.py
```

### 6.3 剪贴板导入器使用
```bash
# 从剪贴板导入数据到Excel并自动生成图片
python clipboard_importer.py
```
**使用流程：**
1. 复制表格数据到剪贴板（支持Excel、网页表格等）
2. 运行剪贴板导入器
3. 选择目标Excel文件（如有多个）
4. 数据自动写入"粘贴"sheet的B2单元格开始区域
5. Excel公式自动重新计算，数据联动到第一个sheet
6. **自动启动PSD渲染器生成图片**，输出到export目录

### 6.4 图层命名规则
- **文本变量**：`@标题#t`（基本文本替换）
- **文本居中**：`@标题#t_c`（居中对齐文本）
- **文本旋转**：`@标题#t_a15`（旋转 15 度）
- **图片变量**：`@产品图#i`（图片替换）
- **可见性变量**：`@水印#v`（显示/隐藏控制）
- **段落文本**：`@描述#t_p`（自动换行段落）

**对齐参数：**
- `_c`：水平居中
- `_r`：水平右对齐
- `_p`：段落文本（自动换行）
- `_pm`：垂直居中（段落）
- `_pb`：垂直底部（段落）

**旋转参数：**
- `_a[角度]`：旋转指定角度（如 `_a15` 旋转15度，`_a-30` 逆时针30度）
- 可与对齐参数组合：`@标题#t_c_a45`（居中 + 旋转45度）

### 6.5 多PSD模板命名规则

**多模板支持：**
- 命名格式：`[前缀]#[后缀].psd`
- Excel文件名需与PSD前缀保持一致
- 例如：`产品.xlsx` 配合 `产品#海报.psd` 和 `产品#方图.psd`
- 输出文件会自动使用PSD后缀区分：`产品1海报.jpg`、`产品1方图.jpg`（假设Excel中File_name为"产品1"）

### 6.6 文本预处理规则

**统一文本处理：**
在将文字写入图片前，系统会统一调用预处理函数进行清理：

- **Excel转义字符清理**：自动清理 `_x000D_`(回车)、`_x000A_`(换行)、`_x0009_`(制表符) 等Excel内部转义字符串
- **成对英文引号清理**：自动删除首尾成对的英文引号
- **空白字符清理**：自动去除首尾的空格、制表符、换行符等空白字符
- **类型转换**：自动将数字、布尔值等非字符串类型转换为字符串
- **空值处理**：将 None 值转换为空字符串
- **文本规范化**：
  - 中文双引号 "" → 中文书名号 「」
  - 斜杠 / → 和号 &
- **保留内部空白**：中间和换行符等空白字符会被保留

**处理时机：**
- 在 `update_text_layer()` 函数开始处统一处理
- 适用于所有文本变量，无论是否段落文本

**示例：**
- `"文本内容"` → `文本内容`（成对引号清理）
- `文本_x000D_` → `文本`
- `  标题  ` → `标题`
- `名称：产品\n` → `名称：产品`
- `True` → `True`（布尔值转换）
- `产品"名称"` → `产品「名称」`
- `A/B/C` → `A&B&C`

### 6.7 文件名处理规则

**输出文件名生成：**
- **基础名称**：使用Excel表格第一列的值作为文件名基础
- **后缀处理**：根据PSD模板的后缀自动添加区分标识
- **多模板支持**：同一数据可生成多个不同模板的图片

**文件名合法性验证：**
为确保跨平台兼容性，程序会自动清理输出文件名：

- **Excel转义字符清理**：自动清理 `_x000D_`(回车)、`_x000A_`(换行)、`_x0009_`(制表符) 等Excel内部转义字符串
- **非法字符替换**：将 `/ \ : * ? " < > |` 等字符替换为下划线
- **控制字符过滤**：移除ASCII控制字符（0-31）
- **首尾清理**：去除文件名开头和结尾的空格和点
- **长度限制**：限制文件名长度不超过200字符
- **空名处理**：如果清理后为空，自动命名为"unnamed"

**示例：**
- `文件名_x000D_` → `文件名`
- `产品/名称*special?` → `产品_名称_special_`
- `  leading spaces  ` → `leading spaces`
- `file:name` → `file_name`

## 7. 测试套件

项目包含完整的测试套件，确保代码质量和功能稳定性。测试套件位于`tests/`目录。

**运行方式：** `python tests/run_tests.py all`

详细的测试文档、分类说明和运行指南，请参考 `tests/README.md`。

## 8. 数据验证系统

### 8.1 验证内容
- **列名匹配**：检查Excel列名与PSD变量的一致性
- **文件路径**：验证图片资源文件是否存在
- **数据完整性**：确保必需变量都有对应数据

### 8.2 错误报告
- **详细错误信息**：指出具体的错误位置和原因
- **修复建议**：提供明确的修复指导
- **优雅退出**：发现错误时停止处理，避免部分导出

## 9. 许可证

本项目使用 **GNU Affero General Public License v3.0** 许可证。任何对该软件的修改和分发，特别是在网络服务器上使用时，都必须开放其源代码。

## 10. 维护说明

### 10.1 版本管理
- 使用`requirements.txt`锁定依赖版本
- 定期更新依赖包以获取安全修复
- 保持向后兼容性

### 10.2 日志记录
- 自动记录每次导出活动到`log.csv`
- 包含生成时间、图片数量、使用的Excel文件
- 便于追踪和审计

### 10.3 性能监控
- 导出过程中显示实时进度
- 统计总处理时间和图片数量
- 支持大规模批量处理（数百张图片）

### 10.4 质量保证
- 运行完整测试套件确保功能正常
- 覆盖边界情况和异常场景
- 详细的测试文档、分类说明和运行指南，请参考 `tests/README.md`
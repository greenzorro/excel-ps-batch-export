# Excel-PS 批量导出工具备忘录

## 1. 目的

本文档旨在详细记录 `projects/excel-ps-batch-export` 目录下的自动化工具项目，为本项目的未来开发与维护提供清晰的指引。

**重要提示：** 每次新增或修改功能后，请务必更新此备忘录，确保文档的准确性和时效性。

## 2. 项目概述

### 2.1 功能定位
本项目是一套 Python 脚本工具，旨在自动化处理“将 Excel 表格中的数据填充到 Photoshop (PSD) 模板中，并批量导出为图片”的工作流程。它是对 Photoshop 内置“变量”功能的有效替代和效率提升，特别适合需要根据大量数据生成统一版式图片的场景。

### 2.2 解决的核心问题
传统使用 Photoshop 变量功能流程繁琐，涉及多次手动操作（如定义变量、导入CSV、导出PSD、再批量转换为JPG/PNG）。本项目通过脚本将流程简化为：**编辑 Excel -> 运行脚本**，极大地提升了效率。

## 3. 核心脚本分析

本项目由三个核心 Python 脚本构成，各司其职。

### 3.1 `create_xlsx.py` - 模板初始化脚本
- **功能**: 扫描同一目录下的 `.psd` 文件，并根据其中特殊命名的图层，自动生成一个包含对应列的 `.xlsx` 文件。
- **执行逻辑**:
    1. 遍历当前目录，查找所有 `.psd` 文件。
    2. 对每个找到的 `.psd` 文件，检查是否存在同名的 `.xlsx` 或 `.xls` 文件。如果不存在，则继续。
    3. 使用 `psd-tools` 库打开 PSD 文件，递归遍历所有图层（包括图层组内的图层）。
    4. 识别以 `@` 开头的变量图层，并根据 `#` 后的操作符（`t`, `v`, `i`）对变量名进行分类。
    5. 创建一个包含 `File_name` 列以及从 PSD 中提取的文本、可见性、图片三类变量列的 DataFrame。
    6. 生成一行示例数据，以指导用户如何填写。
    7. 将 DataFrame 保存为与 PSD 文件同名的 `.xlsx` 文件。

### 3.2 `batch_export.py` - 核心批量导出脚本
- **功能**: 读取指定的 Excel 文件和对应的 PSD 模板，根据 Excel 中的每一行数据生成一张图片。
- **执行逻辑**:
    1. 通过命令行参数接收 `file_name` (模板和数据文件的基本名), `font_file` (字体文件名), 和 `image_format` (输出格式)。
    2. 读取 `{file_name}.xlsx` 文件的数据。
    3. 遍历数据每一行，执行 `export_single_image` 函数。
    4. 在 `export_single_image` 中：
        a. 打开 `{file_name}.psd` 文件。
        b. 创建一个与 PSD 画布大小相同的空白 PIL 图像。
        c. 递归遍历 PSD 图层：
            - 对于普通可见图层，将其渲染并合并到 PIL 图像上。
            - 对于以 `@` 开头的变量图层，根据图层名和 Excel 数据执行相应操作：
                - **可见性 (`#v`)**: 根据 Excel 中的 `TRUE/FALSE` 值设置图层 `visible` 属性。
                - **文本 (`#t`)**: 将图层设为不可见，然后在 PIL 图像的相应位置使用 `Pillow` 绘制 Excel 中指定的文本。此过程会处理字体、大小、颜色、对齐方式（包括段落换行）。
                - **图片 (`#i`)**: 将图层设为不可见，然后读取 Excel 中指定的图片路径，缩放到图层尺寸后，将其合成到 PIL 图像上。
        d. 将最终合成的 PIL 图像保存到 `export` 目录下的带时间戳的子文件夹中。
    5. 所有行处理完毕后，自动打开 `export` 文件夹。

### 3.3 `auto_export.py` - 自动化监控脚本
- **功能**: 监控项目目录下的 Excel 文件，一旦文件被修改，则自动调用 `batch_export.py` 执行导出流程。
- **执行逻辑**:
    1. 首先运行 `create_xlsx.main()` 确保所有 PSD 模板都有对应的 Excel 文件。
    2. 扫描目录，找出所有成对的 `.xlsx` 和 `.psd` 文件。
    3. 为每一对文件创建一个 `asyncio` 任务，用于监控 Excel 文件的修改时间。
    4. 每5秒检查一次文件修改时间。如果时间戳发生变化，则通过 `subprocess.run` 调用 `batch_export.py`，并传入对应的文件名、字体和格式参数。

## 4. 工作流程详解

### 4.1 首次设置
1. **准备 PSD 模板**: 将 `.psd` 文件放入项目根目录。
2. **命名图层**: 在 PSD 文件中，将需要动态修改的图层或图层组按照特定规则重命名（详见 5.1）。
3. **生成 Excel**: 运行 `python create_xlsx.py`，脚本会自动为每个 PSD 文件生成对应的 `.xlsx` 配置文件。
4. **准备素材**: 将字体文件放入 `assets/fonts` 目录，将可能用到的图片素材放入 `assets` 或其他自定义目录。

### 4.2 数据填充与导出
1. **编辑 Excel**: 打开生成的 `.xlsx` 文件，在第一张工作表中填入需要生成的数据。`File_name` 列用于指定输出文件名，若留空则使用默认名。
2. **执行导出**:
    - **手动模式**: 在终端运行 `python batch_export.py [模板名] [字体文件名] [格式]`，例如 `python batch_export.py 1 AlibabaPuHuiTi-2-85-Bold.ttf jpg`。
    - **自动模式**: 运行 `python auto_export.py`，之后每次修改并保存 Excel 文件时，脚本会自动在后台执行导出。

## 5. 关键技术点分析

### 5.1 PSD 图层命名规则
这是本工具的核心约定，所有自动化操作都基于此规则。
- **格式**: `@变量名#操作符_参数`
- **`@`**: 变量图层的起始标记。
- **`变量名`**: 对应 Excel 文件中的列标题。
- **`#`**: 分隔符。
- **`操作符`**:
    - `v`: **Visibility (可见性)**。控制图层的显示和隐藏。
    - `t`: **Text (文本)**。替换文本图层的内容。
    - `i`: **Image (图片)**。替换图片图层的内容。
- **`_参数`** (仅用于文本操作符):
    - `_c`: 水平居中对齐。
    - `_r`: 水平右对齐。
    - `_p`: 段落文本，自动换行。
    - `_pm`: 垂直居中对齐（用于段落文本）。
    - `_pb`: 垂直底部对齐（用于段落文本）。
    - *注：参数可以组合使用，如 `#t_c_p_pm`。*

### 5.2 文本处理机制
- **挑战**: `psd-tools` 库可以读取 PSD 图层信息，但不能直接修改文本内容并完美渲染。
- **解决方案**: 脚本采用了一种混合策略。它从 PSD 图层中读取文本的**位置、尺寸、字体大小、颜色和对齐方式**等元数据，然后将原始文本图层隐藏，改用 `Pillow` (PIL) 在同一位置绘制新的文本内容。这种方法绕过了直接编辑 PSD 文本的复杂性，实现了高效且效果可控的文本替换。

### 5.3 图片处理机制
- **策略**: 与文本处理类似，脚本读取图片图层的位置和尺寸，然后将原始图层隐藏。
- **实现**: 使用 `Pillow` 打开 Excel 中指定路径的新图片，将其尺寸调整为与 PSD 中占位图层一致，然后通过 `alpha_composite` 方法将其精确地合成到最终的图像上。

### 5.4 依赖库
- **`psd-tools`**: 核心库，用于解析和读取 `.psd` 文件结构和图层数据。
- **`pandas`**: 用于高效地读取和处理 `.xlsx` 文件。
- **`openpyxl`**: `pandas` 读写 `.xlsx` 文件所需的引擎。
- **`Pillow` (PIL)**: 用于创建、合成和保存最终的图片文件，以及处理文本和图片绘制。

## 6. 许可证
本项目使用 **GNU Affero General Public License v3.0**。这意味着任何对该软件的修改和分发，特别是在网络服务器上使用时，都必须开放其源代码。

## 7. 未来改进与注意事项
- **性能**: 对于超大尺寸的 PSD 文件或极大量的导出任务，性能可能会有瓶颈。未来可以探索优化图像合成的算法。
- **字体支持**: 当前字体文件需要在脚本中硬编码或通过命令行参数传递。可以考虑优化为自动检测或在 Excel 中指定。
- **错误处理**: 脚本目前对文件不存在等情况有基本的警告，但可以增加更健壮的错误处理和日志记录机制。
- **文本缩放**: `README` 中明确指出，不应使用自由变换（Ctrl/Cmd+T）来缩放文本图层，因为这会导致脚本无法正确获取字体大小。这是 `psd-tools` 的一个限制，用户必须通过字体大小属性来调整文本。

# Excel-PS 批量导出工具备忘录

## 1. 目的

本文档旨在详细记录 `projects/excel-ps-batch-export` 目录下的整个批量导出工具项目，为本项目的未来开发提供便利。

**重要提示：** 每次新增或修改功能后，请务必更新此备忘录，确保文档的准确性和时效性。

## 2. 项目概述

本项目是一套Python自动化工具，用于将Excel表格数据批量填充到Photoshop(PSD)模板中并导出为图片。它是对Photoshop内置"变量"功能的高效替代，特别适合需要根据大量数据生成统一版式图片的场景。

**核心优势：** 将传统繁琐的Photoshop变量操作流程简化为"编辑Excel→运行脚本"的两步操作。

## 2. 项目结构

```
excel-ps-batch-export/
├── create_xlsx.py          # PSD模板扫描和Excel配置文件生成
├── batch_export.py         # 核心批量导出脚本
├── auto_export.py          # 自动化监控脚本
├── requirements.txt        # 项目依赖管理
├── assets/                 # 资源目录
│   ├── fonts/             # 字体文件
│   └── 1_img/             # 示例图片素材
├── export/                # 导出图片目录
├── log_backup.csv         # 导出日志
├── test/                  # 测试套件目录
│   ├── README.md          # 测试套件文档
│   ├── run_tests.py       # 统一测试运行器
│   ├── test_simple.py     # 核心功能测试 (13个测试)
│   ├── test_business_logic.py # 业务逻辑测试 (25个测试)
│   ├── test_error_handling.py # 错误处理测试 (20个测试)
│   ├── test_boundary_conditions.py # 边界条件测试 (6个测试)
│   ├── test_performance.py # 性能测试 (5个测试)
│   ├── test_utils.py      # 测试工具函数
│   └── test_report.html   # HTML测试报告
├── test/test_report.html  # 测试报告
└── notes.md               # 本备忘录
```

## 3. 核心功能

### 3.1 自动化工作流程
- **PSD模板扫描**：自动识别目录中的PSD文件并按前缀分组
- **Excel配置生成**：为每组PSD模板生成共享的Excel配置文件
- **批量图片导出**：读取Excel数据，自动填充到PSD模板并导出
- **实时监控**：监控Excel文件修改，自动触发重新导出

### 3.2 支持的变量类型
- **文本变量** (`@变量名#t`)：替换文本内容，支持多种对齐方式
- **图片变量** (`@变量名#i`)：替换图片内容，自动缩放适配
- **可见性变量** (`@变量名#v`)：控制图层显示/隐藏

### 3.3 高级特性
- **多模板支持**：一个Excel文件可对应多个PSD模板
- **数据验证**：自动检查Excel数据与PSD模板的匹配性
- **并行处理**：使用多进程大幅提升导出速度
- **进度显示**：实时显示导出进度和预估时间
- **错误处理**：提供详细的错误报告和修复建议

## 4. 技术架构

### 4.1 核心依赖
- **psd-tools==1.9.23**：PSD文件解析和处理
- **pandas==2.2.2**：Excel数据读取和处理
- **Pillow==10.3.0**：图像合成和文本绘制
- **tqdm==4.66.4**：进度条显示

### 4.2 关键技术实现
- **PSD预加载**：一次性加载所有PSD模板，避免重复IO操作
- **并行处理**：使用`ProcessPoolExecutor`实现多进程并行导出
- **文本渲染**：通过Pillow实现高质量的文本绘制，支持中英文混合
- **图像合成**：使用`alpha_composite`实现精确的图层合成

### 4.3 性能优化
- **多进程并行**：动态分配工作进程数量（CPU核心数的80%）
- **内存优化**：使用PSD对象深拷贝避免并发冲突
- **IO优化**：预加载PSD模板减少磁盘读取次数

## 5. 使用方法

### 5.1 首次设置
1. **准备PSD模板**：将PSD文件放入项目根目录，命名格式为`[前缀]#[后缀].psd`
2. **命名变量图层**：按照`@变量名#操作符`规则重命名需要动态修改的图层
3. **生成Excel配置**：运行`python create_xlsx.py`生成Excel配置文件
4. **准备资源**：将字体文件放入`assets/fonts`目录

### 5.2 批量导出
```bash
# 手动导出
python batch_export.py [模板名] [字体文件] [格式]
# 示例：python batch_export.py 1 AlibabaPuHuiTi-2-85-Bold.ttf jpg

# 自动监控导出
python auto_export.py
```

### 5.3 图层命名规则
- **文本变量**：`@标题#t_c`（居中对齐文本）
- **图片变量**：`@产品图#i`（图片替换）
- **可见性变量**：`@水印#v`（显示/隐藏控制）
- **段落文本**：`@描述#t_p`（自动换行段落）

**对齐参数：**
- `_c`：水平居中
- `_r`：水平右对齐
- `_p`：段落文本（自动换行）
- `_pm`：垂直居中（段落）
- `_pb`：垂直底部（段落）

## 6. 测试套件

项目包含完整的测试套件，确保代码质量和功能稳定性。测试套件位于`tests/`目录，包含67个测试用例，涵盖所有核心功能模块，通过率达到100%。

完整的测试文档、测试分类说明和运行指南，请参考 `test/README.md`。

## 7. 数据验证系统

### 7.1 验证内容
- **列名匹配**：检查Excel列名与PSD变量的一致性
- **文件路径**：验证图片资源文件是否存在
- **数据完整性**：确保必需变量都有对应数据

### 7.2 错误报告
- **详细错误信息**：指出具体的错误位置和原因
- **修复建议**：提供明确的修复指导
- **优雅退出**：发现错误时停止处理，避免部分导出

## 8. 许可证

本项目使用 **GNU Affero General Public License v3.0** 许可证。任何对该软件的修改和分发，特别是在网络服务器上使用时，都必须开放其源代码。

## 9. 维护说明

### 9.1 版本管理
- 使用`requirements.txt`锁定依赖版本
- 定期更新依赖包以获取安全修复
- 保持向后兼容性

### 9.2 日志记录
- 自动记录每次导出活动到`log.csv`
- 包含生成时间、图片数量、使用的Excel文件
- 便于追踪和审计

### 9.3 性能监控
- 导出过程中显示实时进度
- 统计总处理时间和图片数量
- 支持大规模批量处理（数百张图片）

### 9.4 测试维护
- 运行完整测试套件确保功能正常
- 定期更新测试用例覆盖新功能
- 保持测试代码质量和文档更新